<!DOCTYPE html>
<html lang="ru" data-theme="orange">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VZ.FORUM | Messenger</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root {
            --bg-body: #09090b;       
            --bg-sidebar: rgba(24, 24, 27, 0.75);    
            --bg-chat: rgba(32, 32, 36, 0.85);       
            --bg-element: rgba(63, 63, 70, 0.4);    
            --bg-hover: rgba(82, 82, 91, 0.5);      
            --bg-modal: #18181b;
            --accent: #ff9f1c; 
            --accent-glow: rgba(255, 159, 28, 0.4);
            --accent-hover: #ffb24d;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --error: #ef4444;
            --success: #22c55e;
            --grid-color: rgba(255, 255, 255, 0.03);
            --radius-md: 14px;
            --trans: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="blue"] { --accent: #00a8ff; --accent-glow: rgba(0, 168, 255, 0.4); --accent-hover: #48dbfb; }
        [data-theme="purple"] { --accent: #d946ef; --accent-glow: rgba(217, 70, 239, 0.4); --accent-hover: #f0abfc; }
        [data-theme="green"] { --accent: #4ade80; --accent-glow: rgba(74, 222, 128, 0.4); --accent-hover: #86efac; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        body {
            background-color: var(--bg-body); color: var(--text-main); height: 100vh; width: 100vw; display: flex; overflow: hidden;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); 
            background-size: 40px 40px; transition: var(--trans);
        }

        #loading-screen { position: fixed; inset: 0; z-index: 9999; background: var(--bg-body); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; transition: opacity 0.5s ease; }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .ambient-light { position: fixed; border-radius: 50%; filter: blur(120px); z-index: -1; opacity: 0.4; animation: float 15s infinite ease-in-out alternate; pointer-events: none; transition: background 0.5s ease; }
        .light-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, var(--accent), transparent 70%); }
        .light-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, var(--accent), transparent 70%); opacity: 0.2; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 40px) scale(1.1); } }

        .hidden { display: none !important; }
        .btn { border: none; cursor: pointer; padding: 14px 20px; border-radius: 12px; font-weight: 600; font-size: 15px; transition: var(--trans); display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; overflow: hidden; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: #09090b; box-shadow: 0 4px 20px var(--accent-glow); }
        .btn-primary:not(:disabled):hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-ghost { background: transparent; color: var(--text-muted); font-size: 14px; }
        .btn-ghost:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.25); }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: var(--text-muted); cursor: pointer; transition: var(--trans); display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .icon-btn:hover { background: var(--bg-hover); color: var(--accent); }

        .input-group { position: relative; margin-bottom: 15px; width: 100%; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 18px; pointer-events: none; transition: var(--trans); }
        input, textarea { background: rgba(20, 20, 25, 0.6); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); padding: 16px 16px 16px 45px; border-radius: 14px; width: 100%; outline: none; font-size: 15px; transition: var(--trans); resize: none; }
        textarea { padding: 16px; }
        input:focus, textarea:focus { background: rgba(30, 30, 35, 0.8); border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        input:focus + .input-icon { color: var(--accent); }

        #app { width: 100%; height: 100%; display: flex; background: var(--bg-chat); backdrop-filter: blur(20px); }
        .auth-wrapper { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: var(--bg-body); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 40px 40px; }
        .auth-card { width: 100%; max-width: 420px; padding: 45px 40px; background: rgba(20, 20, 25, 0.85); border-radius: 30px; text-align: center; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 30px 80px -20px rgba(0,0,0,0.8); animation: slideUp 0.5s ease-out; backdrop-filter: blur(20px); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .auth-logo { font-size: 36px; font-weight: 800; margin-bottom: 30px; background: linear-gradient(135deg, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-switch { margin-top: 25px; font-size: 14px; color: var(--text-muted); }
        .auth-switch span { color: var(--accent); cursor: pointer; font-weight: 600; margin-left: 5px; }

        .sidebar { width: 340px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05); flex-shrink: 0; backdrop-filter: blur(10px); }
        .sidebar-header { padding: 24px; display: flex; align-items: center; justify-content: space-between; }
        
        .user-mini { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px 12px; border-radius: var(--radius-md); transition: var(--trans); }
        .user-mini:hover { background: var(--bg-hover); }
        
        .avatar { 
            width: 44px; height: 44px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #3f3f46, #27272a); 
            color: var(--text-main); 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 700; font-size: 16px; 
            overflow: hidden; 
            flex-shrink: 0; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        
        .avatar img { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            display: block;
        }

        .nav-tabs { display: flex; padding: 0 24px 10px; gap: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-tab { font-size: 14px; font-weight: 500; color: var(--text-muted); cursor: pointer; padding-bottom: 10px; position: relative; transition: var(--trans); }
        .nav-tab.active { color: var(--text-main); font-weight: 600; }
        .nav-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--accent); border-radius: 2px; box-shadow: 0 0 10px var(--accent); transition: var(--trans); }
        .list-wrap { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* --- NEW: Smooth Animation for List Items --- */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-item { display: flex; align-items: center; gap: 14px; padding: 12px; border-radius: 16px; cursor: pointer; transition: var(--trans); margin-bottom: 4px; animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        .chat-item:hover { background: var(--bg-hover); transform: translateX(4px); }
        .chat-name { font-weight: 600; font-size: 15px; color: var(--text-main); display: flex; align-items: center; gap: 5px; }
        .chat-last { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: transparent; }
        .chat-topbar { height: 75px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); z-index: 10; cursor: pointer; }
        .messages-list { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-row { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 8px; max-width: 75%; animation: slideIn 0.3s ease forwards; }
        
        .msg-avatar { 
            width: 32px; height: 32px; 
            border-radius: 50%; 
            background: var(--bg-element); 
            flex-shrink: 0; 
            overflow: hidden; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 12px; font-weight: bold; 
        }
        .msg-avatar img { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            display: block;
        }

        .msg { padding: 12px 18px; border-radius: 20px; position: relative; font-size: 15px; line-height: 1.5; word-wrap: break-word; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .msg.in { align-self: flex-start; background: var(--bg-element); color: var(--text-main); border-bottom-left-radius: 4px; max-width: 100%; animation: slideIn 0.3s ease forwards; }
        .msg.out { max-width: 70%; align-self: flex-end; background: var(--accent); color: #09090b; border-bottom-right-radius: 4px; font-weight: 600; box-shadow: 0 4px 20px var(--accent-glow); cursor: pointer; transition: 0.2s; margin-bottom: 8px; animation: slideIn 0.3s ease forwards; }
        .msg.out:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .msg-time { font-size: 10px; opacity: 0.6; text-align: right; margin-top: 4px; }
        .input-bar { padding: 20px 30px; background: rgba(0,0,0,0.2); display: flex; align-items: flex-end; gap: 12px; border-top: 1px solid rgba(255,255,255,0.05); }

        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: var(--trans); }
        .modal-bg.active { opacity: 1; pointer-events: all; }
        .modal-panel { background: var(--bg-modal); width: 90%; max-width: 450px; padding: 0; border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 25px 60px rgba(0,0,0,0.5); transform: scale(0.95) translateY(10px); transition: var(--trans); display: flex; flex-direction: column; max-height: 85vh; overflow: hidden; position: relative; }
        .modal-bg.active .modal-panel { transform: scale(1) translateY(0); }
        
        .profile-banner { 
            width: 100%; height: 130px; 
            background-color: var(--accent-glow); 
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat;
            position: relative; 
        }
        .profile-banner-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); opacity: 0; transition: 0.2s; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: 700; font-size: 12px; letter-spacing: 1px; }
        .profile-banner:hover .profile-banner-overlay { opacity: 1; }
        
        .profile-header { padding: 0 30px; margin-top: -50px; display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; }
        .avatar-large-wrapper { position: relative; padding: 4px; background: var(--bg-modal); border-radius: 50%; }
        
        .avatar-big { 
            width: 100px; height: 100px; 
            border-radius: 50%; 
            background: var(--bg-element); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 36px; 
            position: relative; 
            overflow: hidden; 
        }
        .avatar-big img {
            width: 100%; height: 100%;
            object-fit: cover;
            display: block;
        }

        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; transition: var(--trans); cursor: pointer; color: white; font-size: 11px; font-weight: 700; letter-spacing: 1px; }
        .avatar-big:hover .avatar-overlay { opacity: 1; }
        .profile-body { padding: 20px 30px 30px; }

        .theme-selector { display: flex; gap: 15px; justify-content: center; margin: 15px 0; }
        .theme-circle { width: 42px; height: 42px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .theme-circle:hover { transform: scale(1.1); }
        .theme-circle.active { border-color: white; transform: scale(1.15); box-shadow: 0 0 15px var(--accent); }
        .t-orange { background: linear-gradient(135deg, #ff9f1c, #ffcc00); }
        .t-blue { background: linear-gradient(135deg, #00a8ff, #0097e6); }
        .t-purple { background: linear-gradient(135deg, #d946ef, #8b5cf6); }
        .t-green { background: linear-gradient(135deg, #4ade80, #22c55e); }
        
        .select-user-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; cursor: pointer; margin-bottom: 5px; transition: 0.2s; background: rgba(255,255,255,0.02); }
        .select-user-item:hover { background: var(--bg-hover); }
        .select-user-item.selected { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--accent); }
        .checkmark { width: 20px; height: 20px; border: 2px solid var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0; transition: var(--trans); }
        .select-user-item.selected .checkmark { border-color: var(--accent); background: var(--accent); color: #000; font-size: 12px; }

        .file-card { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); text-decoration: none; color: inherit; transition: 0.2s; max-width: 100%; }
        .file-card:hover { background: rgba(0,0,0,0.3); border-color: var(--accent); }
        .file-icon { font-size: 24px; }
        .file-info { display: flex; flex-direction: column; overflow: hidden; }
        .file-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; opacity: 0.7; }

        @media (max-width: 768px) {
            .sidebar { position: absolute; inset: 0; z-index: 50; width: 100%; transition: transform 0.3s ease; }
            .sidebar.hidden-mobile { transform: translateX(-100%); }
            .back-btn { display: block !important; margin-right: 15px; }
        }
        .back-btn { display: none; }
        .toast { position: fixed; top: 20px; right: 20px; background: var(--bg-modal); padding: 16px 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.4); transform: translateX(120%); transition: var(--trans); z-index: 1000; display: flex; align-items: center; gap: 12px; border-left: 4px solid var(--accent); }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-screen-spinner"></div>
        <div style="font-weight: 600; letter-spacing: 2px; color: var(--text-muted); font-size: 14px;">–ó–ê–ì–†–£–ó–ö–ê...</div>
    </div>

    <div class="ambient-light light-1"></div>
    <div class="ambient-light light-2"></div>
    <div id="toast-container"></div>

    <div id="auth-section" class="auth-wrapper hidden">
        <div class="auth-card">
            <div class="auth-logo">VZ.FORUM</div>
            <div id="login-form">
                <div class="input-group"><span class="input-icon">‚úâ</span><input type="email" id="login-email" placeholder="Email"></div>
                <div class="input-group"><span class="input-icon">üîí</span><input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                <button class="btn btn-primary" id="btn-login" style="width: 100%;" onclick="login()">–í–æ–π—Ç–∏</button>
                <div class="auth-switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span onclick="toggleAuth('register')">–°–æ–∑–¥–∞—Ç—å</span></div>
            </div>
            <div id="register-form" class="hidden">
                <div class="input-group"><span class="input-icon">‚úâ</span><input type="email" id="register-email" placeholder="Email"></div>
                <div class="input-group"><span class="input-icon">üîí</span><input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                <div class="input-group"><span class="input-icon">üîí</span><input type="password" id="register-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
                <button class="btn btn-primary" id="btn-register" style="width: 100%;" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <div class="auth-switch">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span onclick="toggleAuth('login')">–í–æ–π—Ç–∏</span></div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-mini" onclick="openMyProfile()">
                    <div class="avatar" id="my-avatar-mini">U</div>
                    <div><div style="font-weight: 700; font-size: 15px;" id="my-nickname-mini">User</div><div style="font-size: 11px; color: var(--accent);">‚óè –í —Å–µ—Ç–∏</div></div>
                </div>
            </div>
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('chats')">–°–æ–æ–±—â–µ–Ω–∏—è</div>
                <div class="nav-tab" onclick="switchTab('search')">–ü–æ–∏—Å–∫</div>
            </div>
            <div id="chats-list" class="list-wrap"></div>
            <div id="search-list" class="list-wrap hidden">
                <div class="input-group" style="padding: 0 10px;"><span class="input-icon" style="left: 20px;">üîç</span><input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ username..."></div>
                <div id="search-results"></div>
            </div>
            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.05);">
                <button class="btn btn-ghost" style="width: 100%; color: var(--error); justify-content: flex-start;" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            </div>
        </div>

        <div class="chat-area">
            <div id="empty-state" style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted);">
                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.2;">üí¨</div>
                <div style="font-size: 18px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
            </div>
            <div id="chat-view" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <div class="chat-topbar" onclick="openChatInfo()">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button class="icon-btn back-btn" onclick="closeChatMobile(event)">‚Üê</button>
                        <div class="avatar" id="header-avatar">U</div>
                        <div><div style="font-weight: 700; font-size: 17px;" id="header-name">Name</div><div style="font-size: 12px; color: var(--text-muted);" id="header-sub">–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div></div>
                    </div>
                    <button class="icon-btn">‚ãÆ</button>
                </div>
                <div id="messages-container" class="messages-list"></div>
                <div class="input-bar">
                    <div id="edit-indicator" class="hidden" style="position: absolute; bottom: 80px; left: 30px; background: var(--bg-modal); padding: 8px 16px; border-radius: 12px; border: 1px solid var(--accent); display: flex; align-items: center; gap: 10px; z-index: 20; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <span style="font-size: 12px; color: var(--accent); font-weight: bold;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                        <button onclick="cancelEdit()" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">‚úï</button>
                    </div>
                    <div id="upload-indicator" class="hidden" style="position: absolute; bottom: 80px; right: 30px; background: var(--bg-modal); padding: 8px 16px; border-radius: 12px; border: 1px solid var(--success); color: var(--success); font-weight:bold; z-index: 20;">
                        ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>

                    <label class="icon-btn" style="flex-shrink: 0; cursor: pointer;"><input type="file" id="file-input" hidden multiple>üìé</label>
                    <textarea id="message-input" rows="1" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                    <button class="btn btn-primary" onclick="handleSend()" style="padding: 12px; border-radius: 50%; width: 46px; height: 46px;">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="msg-options-modal" class="modal-bg">
        <div class="modal-panel" style="max-width: 320px; padding: 25px;">
            <h3 style="text-align: center; margin-bottom: 20px;">–î–µ–π—Å—Ç–≤–∏—è</h3>
            <button class="btn btn-ghost" onclick="triggerEditFromModal()" style="margin-bottom: 12px; width: 100%; justify-content: center; background: rgba(255,255,255,0.05);">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-danger" onclick="triggerDeleteFromModal()" style="width: 100%; justify-content: center;">üóë –£–¥–∞–ª–∏—Ç—å</button>
            <button class="btn btn-ghost" onclick="closeModal('msg-options-modal')" style="margin-top: 15px; width: 100%;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="my-profile-modal" class="modal-bg">
        <div class="modal-panel">
            <div class="profile-banner" id="my-banner-preview"><label class="profile-banner-overlay"><input type="file" onchange="uploadBanner(this.files[0])" hidden accept="image/*">–ò–ó–ú–ï–ù–ò–¢–¨ –ë–ê–ù–ù–ï–†</label></div>
            <div class="profile-header">
                <div class="avatar-large-wrapper"><div class="avatar-big"><div id="my-profile-avatar-content">U</div><label class="avatar-overlay"><input type="file" onchange="uploadAvatar(this.files[0])" hidden accept="image/*">–ò–ó–ú–ï–ù–ò–¢–¨</label></div></div>
            </div>
            <div class="profile-body">
                <div style="font-size: 12px; text-align: center; color: var(--text-muted); margin-bottom: 12px;">–¶–í–ï–¢–û–í–ê–Ø –¢–ï–ú–ê</div>
                <div class="theme-selector">
                    <div class="theme-circle t-orange" onclick="setTheme('orange')"></div>
                    <div class="theme-circle t-blue" onclick="setTheme('blue')"></div>
                    <div class="theme-circle t-purple" onclick="setTheme('purple')"></div>
                    <div class="theme-circle t-green" onclick="setTheme('green')"></div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="input-group"><span class="input-icon">üë§</span><input type="text" id="profile-nickname" placeholder="–ù–∏–∫–Ω–µ–π–º"></div>
                    <div class="input-group"><span class="input-icon">@</span><input type="text" id="profile-username" placeholder="Username"></div>
                    <textarea id="profile-bio" rows="2" placeholder="–û —Å–µ–±–µ..."></textarea>
                </div>
                <div style="margin-top: 25px; display: flex; gap: 10px;">
                    <button class="btn btn-ghost" style="flex: 1;" onclick="closeModal('my-profile-modal')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-profile-modal" class="modal-bg">
        <div class="modal-panel">
            <div class="profile-banner" id="view-banner"></div>
            <div class="profile-header">
                <div class="avatar-large-wrapper"><div class="avatar-big" style="border: none;"><div id="view-avatar">U</div></div></div>
            </div>
            <div class="profile-body" style="text-align: center;">
                <h2 id="view-nickname" style="margin-bottom: 5px;">Nick</h2>
                <p id="view-username" style="color: var(--accent); margin-bottom: 20px;">@name</p>
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.05);"><p id="view-bio" style="font-size: 14px; line-height: 1.5;">...</p></div>
                <button class="btn btn-ghost" style="width: 100%; margin-top: 20px;" onclick="closeModal('user-profile-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD5uS50WpC2KRXDYY0XNV8II23kbHR_da0",
            authDomain: "hoto-d9e96.firebaseapp.com",
            projectId: "hoto-d9e96",
            storageBucket: "hoto-d9e96.firebasestorage.app",
            messagingSenderId: "1024787203382",
            appId: "1:1024787203382:web:5eb5e82a3337a53ec75f97"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // API KEYS
        const IMGBB_API_KEY = "bf02b08a3e2439c1b663ef266e15fe2b"; 
        const GOFILE_API_TOKEN = "BppkhLswk2sxwwcaCqthzQLw87BWcUu1";

        let currentUser = null, currentChat = null, currentChatData = null, chatsListener = null, messagesListener = null;
        let editMsgId = null, tempActionMsgId = null, tempActionMsgText = null;
        let userCache = {};
        let searchTimeout = null; // FIX: Debounce

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            const input = document.getElementById('message-input');
            input.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
            input.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
            
            // FIX: Search debounce
            document.getElementById('search-input').addEventListener('input', e => { 
                clearTimeout(searchTimeout);
                const val = e.target.value.trim();
                if(!val) { document.getElementById('search-results').innerHTML = ''; return; }
                searchTimeout = setTimeout(() => searchUsers(val), 500); 
            });
            
            document.getElementById('file-input').addEventListener('change', e => { if(e.target.files.length) uploadFiles(e.target.files); });
        });

        auth.onAuthStateChanged(async user => {
            const loader = document.getElementById('loading-screen');
            if (user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if(doc.exists && !doc.data().banned) {
                    currentUser = { uid: user.uid, ...doc.data() };
                    loader.classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    updateMyProfileUI(); loadChats(); initGlobalNotifications();
                } else { 
                    alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞'); 
                    auth.signOut(); 
                    loader.classList.add('hidden');
                    document.getElementById('auth-section').classList.remove('hidden');
                }
            } else { 
                loader.classList.add('hidden');
                document.getElementById('auth-section').classList.remove('hidden'); 
                document.getElementById('app').classList.add('hidden');
            }
        });

        // --- FILE UPLOAD LOGIC ---
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const data = await response.json();
                if (data.success) return data.data.url;
                else throw new Error("Upload failed");
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                return null;
            }
        }

        async function uploadToGofile(file) {
            try {
                const serverData = await fetch('https://api.gofile.io/getServer').then(r => r.json());
                if (serverData.status !== 'ok') throw new Error('Gofile server busy');
                const server = serverData.data.server;

                const formData = new FormData();
                formData.append("file", file);
                formData.append("token", GOFILE_API_TOKEN);
                
                const upload = await fetch(`https://${server}.gofile.io/uploadFile`, { method: "POST", body: formData }).then(r => r.json());
                
                if (upload.status === 'ok') {
                    return upload.data.downloadPage;
                } else {
                    throw new Error('Upload error');
                }
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–∞–π–ª –ø–æ–º–µ–Ω—å—à–µ –∏–ª–∏ –ø–æ–∑–∂–µ.");
                return null;
            }
        }

        function setButtonLoading(btnId, isLoading, text) { const btn = document.getElementById(btnId); if(isLoading) { btn.disabled = true; btn.innerHTML = `<div class="loader-spinner" style="width:20px;height:20px;border-width:2px;"></div>`; } else { btn.disabled = false; btn.innerHTML = text; } }
        function login() { setButtonLoading('btn-login', true, ''); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => { showToast(err.message); setButtonLoading('btn-login', false, '–í–æ–π—Ç–∏'); }); }
        async function register() { setButtonLoading('btn-register', true, ''); const e = document.getElementById('register-email').value, p = document.getElementById('register-password').value; if(p !== document.getElementById('register-confirm').value) { showToast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); setButtonLoading('btn-register', false, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'); return; } try { const cred = await auth.createUserWithEmailAndPassword(e, p); await db.collection('users').doc(cred.user.uid).set({ email: e, nickname: e.split('@')[0], username: 'user_'+Math.floor(Math.random()*10000), bio: '', createdAt: firebase.firestore.FieldValue.serverTimestamp(), banned: false }); } catch(err) { showToast(err.message); setButtonLoading('btn-register', false, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'); } }
        
        function logout() { 
            if(chatsListener) chatsListener(); 
            if(messagesListener) messagesListener();
            auth.signOut(); 
            window.location.reload(); 
        }
        function toggleAuth(type) { document.getElementById('login-form').classList.toggle('hidden', type !== 'login'); document.getElementById('register-form').classList.toggle('hidden', type !== 'register'); }

        // --- CHAT LOADING ---
        function loadChats() {
            if(chatsListener) chatsListener(); 
            
            const list = document.getElementById('chats-list'); 
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            chatsListener = db.collection('chats').where('participants', 'array-contains', currentUser.uid).onSnapshot(async snapshot => {
                const chats = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if((!data.type || data.type !== 'group') && data.lastMessage) {
                        chats.push({ id: doc.id, ...data });
                    }
                });
                
                chats.sort((a,b) => {
                    // FIX: Handle missing timestamps (new messages locally)
                    const tA = a.lastMessageTime ? a.lastMessageTime.toMillis() : Date.now();
                    const tB = b.lastMessageTime ? b.lastMessageTime.toMillis() : Date.now();
                    return tB - tA;
                });
                
                list.innerHTML = '';
                
                if(chats.length === 0) { 
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">–ù–µ—Ç —á–∞—Ç–æ–≤</div>'; 
                    return; 
                }
                
                // Add staggered animation delay
                let delay = 0;
                for(const chat of chats) {
                    let name, avatar;
                    const otherId = chat.participants.find(id => id !== currentUser.uid); 
                    if(!otherId) continue; 
                    
                    const uSnap = await db.collection('users').doc(otherId).get(); 
                    const uData = uSnap.data() || { nickname: 'Unknown' };
                    name = uData.nickname; 
                    avatar = uData.avatarURL;
                    
                    const time = chat.lastMessageTime ? new Date(chat.lastMessageTime.toDate()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '...';
                    
                    const div = document.createElement('div'); 
                    div.className = 'chat-item'; 
                    div.style.animationDelay = `${delay}s`; // Stagger animation
                    delay += 0.05;

                    div.onclick = () => openChat(chat);
                    div.innerHTML = `<div class="avatar">${avatar ? `<img src="${avatar}">` : name?name[0]:'?'}</div><div style="flex:1; overflow:hidden;"><div style="display:flex; justify-content:space-between; margin-bottom:4px;"><div class="chat-name">${name}</div><div style="font-size:11px; color:var(--text-muted);">${time}</div></div><div class="chat-last">${chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div></div>`;
                    list.appendChild(div);
                }
            });
        }

        async function searchUsers(q) {
            const res = document.getElementById('search-results'); res.innerHTML = '–ü–æ–∏—Å–∫...';
            const snap = await db.collection('users').where('username', '>=', q).where('username', '<=', q+'\uf8ff').limit(5).get();
            res.innerHTML = ''; 
            snap.forEach(doc => { 
                if(doc.id !== currentUser.uid) { 
                    const u = doc.data(); 
                    const div = document.createElement('div'); 
                    div.className = 'chat-item'; 
                    div.style.animation = 'none'; div.style.opacity = '1'; // No animation for search results
                    div.onclick = () => createDirectChat(doc.id); 
                    div.innerHTML = `<div class="avatar">${u.avatarURL ? `<img src="${u.avatarURL}">` : u.nickname[0]}</div><div><div class="chat-name">${u.nickname}</div><div style="font-size:12px;">@${u.username}</div></div>`; 
                    res.appendChild(div); 
                } 
            });
            if(res.innerHTML === '') res.innerHTML = '<div style="text-align:center; padding:10px; opacity:0.5;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        }
        
        async function createDirectChat(uid) {
            const snap = await db.collection('chats').where('participants', 'array-contains', currentUser.uid).get(); let found = null;
            snap.forEach(d => { const da = d.data(); if(da.type !== 'group' && da.participants.includes(uid)) found = {id: d.id, ...da}; });
            if(found) openChat(found); else { const ref = await db.collection('chats').add({ participants: [currentUser.uid, uid], createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastMessage: '' }); openChat({ id: ref.id, participants: [currentUser.uid, uid] }); }
            switchTab('chats');
        }

        async function openChat(chat) {
            currentChatData = chat; currentChat = { id: chat.id, type: chat.type };
            const hName = document.getElementById('header-name'); const hSub = document.getElementById('header-sub'); const hAv = document.getElementById('header-avatar');
            
            hName.textContent = '...'; hAv.innerHTML = '';
            
            const otherId = chat.participants.find(id => id !== currentUser.uid); 
            const uSnap = await db.collection('users').doc(otherId).get(); 
            const uData = uSnap.data(); 
            currentChat.otherUser = uData;
            
            hName.textContent = uData.nickname; 
            hSub.textContent = '@'+uData.username; 
            hAv.innerHTML = uData.avatarURL ? `<img src="${uData.avatarURL}">` : uData.nickname[0];
            
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.add('hidden-mobile');
            document.getElementById('empty-state').classList.add('hidden'); document.getElementById('chat-view').classList.remove('hidden');
            loadMessages(chat.id);
        }

        function loadMessages(chatId) {
            if(messagesListener) messagesListener();
            const cont = document.getElementById('messages-container'); cont.innerHTML = '';
            messagesListener = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc').onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    if(change.type === 'added') renderMessage(change.doc.data(), change.doc.id);
                    if(change.type === 'modified') { const el = document.getElementById(change.doc.id); if(el) el.innerHTML = renderMsgInnerHtml(change.doc.data()); }
                    if(change.type === 'removed') { const el = document.getElementById(change.doc.id); if(el) el.remove(); }
                });
                scrollToBottom();
            });
        }
        
        // FIX: Scroll Helper
        function scrollToBottom() {
            const cont = document.getElementById('messages-container');
            cont.scrollTop = cont.scrollHeight;
        }

        async function resolveUserAvatar(uid, targetId) {
            if (!userCache[uid]) {
                const snap = await db.collection('users').doc(uid).get();
                if (snap.exists) userCache[uid] = snap.data();
            }
            const u = userCache[uid];
            const el = document.getElementById(targetId);
            if (el && u) {
                el.innerHTML = u.avatarURL ? `<img src="${u.avatarURL}">` : u.nickname[0];
            }
        }

        function renderMessage(d, id) {
            const isMine = d.senderId === currentUser.uid;
            
            if (d.isSystem) {
                const div = document.createElement('div');
                div.id = id;
                div.style.cssText = "align-self:center;font-size:11px;opacity:0.7;background:transparent;box-shadow:none;padding:5px;";
                div.innerHTML = d.text;
                document.getElementById('messages-container').appendChild(div);
                return;
            }

            if (isMine) {
                const div = document.createElement('div');
                div.className = 'msg out';
                div.id = id;
                if(d.type !== 'file') div.onclick = (e) => { e.stopPropagation(); openMsgOptions(id, d.text); };
                div.innerHTML = renderMsgInnerHtml(d);
                document.getElementById('messages-container').appendChild(div);
            } else {
                const wrapper = document.createElement('div');
                wrapper.className = 'msg-row';
                
                const avatar = document.createElement('div');
                avatar.className = 'msg-avatar';
                avatar.id = `av-${id}`;
                avatar.innerHTML = '?'; 
                
                const msgDiv = document.createElement('div');
                msgDiv.className = 'msg in';
                msgDiv.id = id;
                msgDiv.innerHTML = renderMsgInnerHtml(d);
                
                wrapper.appendChild(avatar);
                wrapper.appendChild(msgDiv);
                
                document.getElementById('messages-container').appendChild(wrapper);
                resolveUserAvatar(d.senderId, `av-${id}`);
            }
        }

        function renderMsgInnerHtml(d) {
            let content = d.text || ''; 
            
            if(d.type === 'file' && d.fileURL) {
                const isImage = (d.fileType && d.fileType.startsWith('image/')) || 
                                (typeof d.fileURL === 'string' && d.fileURL.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i));

                if (isImage) {
                    // FIX: Trigger scroll on image load
                    content = `<img src="${d.fileURL}" onload="scrollToBottom()" style="max-width:100%; min-width: 100px; min-height: 100px; border-radius:10px; cursor:pointer; display:block; object-fit: cover;" onclick="window.open('${d.fileURL}')" alt="–ó–∞–≥—Ä—É–∑–∫–∞...">`;
                } else {
                    content = `<a href="${d.fileURL}" target="_blank" class="file-card"><div class="file-icon">${d.fileType && d.fileType.startsWith('video/')?'üé¨':'üìÅ'}</div><div class="file-info"><div class="file-name">${d.fileName || '–§–∞–π–ª'}</div><div class="file-meta">–û—Ç–∫—Ä—ã—Ç—å</div></div></a>`;
                }
            }

            // FIX: Timestamp check
            const time = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '–æ—Ç–ø—Ä–∞–≤–∫–∞...';
            
            if (!content && d.type !== 'file') content = '<span style="opacity:0.5; font-style:italic;">(–ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)</span>';

            return `${content}<div class="msg-time">${time} ${d.edited ? '‚Ä¢ —Ä–µ–¥.' : ''}</div>`;
        }

        function openMsgOptions(id, text) { tempActionMsgId = id; tempActionMsgText = text; document.getElementById('msg-options-modal').classList.add('active'); }
        function triggerEditFromModal() { closeModal('msg-options-modal'); startEdit(tempActionMsgId, tempActionMsgText); }
        function triggerDeleteFromModal() { closeModal('msg-options-modal'); deleteMessage(tempActionMsgId); }
        function startEdit(id, text) { editMsgId = id; document.getElementById('message-input').value = text; document.getElementById('message-input').focus(); document.getElementById('edit-indicator').classList.remove('hidden'); }
        function cancelEdit() { editMsgId = null; document.getElementById('message-input').value = ''; document.getElementById('edit-indicator').classList.add('hidden'); }
        async function deleteMessage(id) { await db.collection('chats').doc(currentChat.id).collection('messages').doc(id).delete(); }
        
        async function handleSend() {
            const inp = document.getElementById('message-input'), txt = inp.value.trim();
            if(!txt || !currentChat) return; // FIX: Prevent empty spaces
            
            if(editMsgId) { 
                await db.collection('chats').doc(currentChat.id).collection('messages').doc(editMsgId).update({ text: txt, edited: true }); 
                cancelEdit(); 
            }
            else { 
                inp.value = ''; inp.style.height='auto';
                await db.collection('chats').doc(currentChat.id).collection('messages').add({ text: txt, senderId: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                await db.collection('chats').doc(currentChat.id).update({ lastMessage: txt, lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), lastMessageSender: currentUser.uid });
            }
        }
        
        async function uploadFiles(files) {
            if(!currentChat) return;
            const loader = document.getElementById('upload-indicator');
            loader.classList.remove('hidden'); 
            
            for(let file of files) {
                let url = null;
                if (file.type.startsWith('image/') && file.size < 32 * 1024 * 1024) { url = await uploadToImgBB(file); } 
                else { url = await uploadToGofile(file); }

                if (url) {
                    await db.collection('chats').doc(currentChat.id).collection('messages').add({ 
                        text: '', 
                        type: 'file', 
                        fileName: file.name, 
                        fileType: file.type, 
                        fileURL: url, 
                        senderId: currentUser.uid, 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    
                    await db.collection('chats').doc(currentChat.id).update({ 
                        lastMessage: (file.type.startsWith('image/') ? 'üì∑ –§–æ—Ç–æ' : 'üìÅ –§–∞–π–ª'), 
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                        lastMessageSender: currentUser.uid 
                    });
                }
            }
            loader.classList.add('hidden'); 
        }

        function openChatInfo() { 
            if(!currentChatData) return; 
            if(currentChat.otherUser) showUserProfile(currentChat.otherUser); 
        }
        
        function switchTab(t) { document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active')); document.querySelector(`.nav-tab[onclick="switchTab('${t}')"]`).classList.add('active'); document.getElementById('chats-list').classList.toggle('hidden', t!=='chats'); document.getElementById('search-list').classList.toggle('hidden', t!=='search'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function closeChatMobile(e) { e.stopPropagation(); document.getElementById('sidebar').classList.remove('hidden-mobile'); }
        
        function showUserProfile(u) {
            document.getElementById('view-nickname').innerText = u.nickname;
            document.getElementById('view-username').innerText = '@'+u.username;
            document.getElementById('view-bio').innerText = u.bio || '...';
            document.getElementById('view-avatar').innerHTML = u.avatarURL?`<img src="${u.avatarURL}">`:u.nickname[0];
            const bnr = document.getElementById('view-banner');
            bnr.style.backgroundImage = u.bannerURL ? `url(${u.bannerURL})` : 'none';
            bnr.style.backgroundColor = u.bannerURL ? 'transparent' : 'var(--accent-glow)';
            document.getElementById('user-profile-modal').classList.add('active');
        }

        function openMyProfile() {
            document.getElementById('profile-nickname').value = currentUser.nickname;
            document.getElementById('profile-username').value = currentUser.username;
            document.getElementById('profile-bio').value = currentUser.bio || '';
            document.getElementById('my-profile-avatar-content').innerHTML = currentUser.avatarURL ? `<img src="${currentUser.avatarURL}">` : currentUser.nickname[0];
            const bnr = document.getElementById('my-banner-preview');
            bnr.style.backgroundImage = currentUser.bannerURL ? `url(${currentUser.bannerURL})` : 'none';
            bnr.style.backgroundColor = currentUser.bannerURL ? 'transparent' : 'var(--accent-glow)';
            document.getElementById('my-profile-modal').classList.add('active');
        }

        async function saveProfile() { await db.collection('users').doc(currentUser.uid).update({ nickname: document.getElementById('profile-nickname').value, username: document.getElementById('profile-username').value, bio: document.getElementById('profile-bio').value }); location.reload(); }
        async function uploadAvatar(file) { const u = await uploadToImgBB(file); await db.collection('users').doc(currentUser.uid).update({ avatarURL: u }); currentUser.avatarURL = u; updateMyProfileUI(); openMyProfile(); }
        async function uploadBanner(file) { const u = await uploadToImgBB(file); await db.collection('users').doc(currentUser.uid).update({ bannerURL: u }); currentUser.bannerURL = u; openMyProfile(); }

        function updateMyProfileUI() { document.getElementById('my-nickname-mini').innerText = currentUser.nickname; document.getElementById('my-avatar-mini').innerHTML = currentUser.avatarURL ? `<img src="${currentUser.avatarURL}">` : currentUser.nickname[0]; }
        function initGlobalNotifications() { db.collection('chats').where('participants','array-contains',currentUser.uid).onSnapshot(snap => { snap.docChanges().forEach(c => { if(c.type==='modified') { const d = c.doc.data(); if(d.lastMessageSender !== currentUser.uid && (!currentChat || currentChat.id !== c.doc.id)) { showToast(`–°–æ–æ–±—â–µ–Ω–∏–µ: ${d.lastMessage}`); } } }); }); }
        function showToast(txt) { const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = `<div>üîî</div><div>${txt.length>30?txt.slice(0,30)+'...':txt}</div>`; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},3000); }
        
        function initTheme() { const t = localStorage.getItem('theme') || 'orange'; setTheme(t); }
        function setTheme(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); document.querySelectorAll('.theme-circle').forEach(c => c.classList.remove('active')); const ac = document.querySelector(`.t-${t}`); if(ac) ac.classList.add('active'); }
    </script>
</body>
</html>
