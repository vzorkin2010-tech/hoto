// === ПЕРЕМЕННЫЕ ДЛЯ ЗВОНКОВ ===
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let callListener = null;
let currentCall = null;
let callTimer = null;
let callStartTime = null;
let isMuted = false;
let isVideoOff = false;
let callType = null; // 'video' или 'voice'
let activeCallListener = null;
let currentActiveCall = null;
let callAnswerListener = null;
let iceCandidateListener = null;

// Конфигурация STUN/TURN серверов для WebRTC
const pcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// === ОСНОВНЫЕ ФУНКЦИИ ЗВОНКОВ ===

function initCallListeners() {
    if (!currentUser) return;

    // Слушаем входящие звонки
    callListener = db.collection('calls')
        .where('to', '==', currentUser.uid)
        .where('status', '==', 'calling')
        .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const callData = change.doc.data();
                    showIncomingCall(callData, change.doc.id);
                }
            });
        });
}

function initActiveCallListener() {
    if (currentUser && currentChat) {
        if (activeCallListener) {
            activeCallListener();
        }
        
        activeCallListener = db.collection('calls')
            .where('chatId', '==', currentChat.id)
            .where('status', 'in', ['calling', 'accepted'])
            .onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const callData = change.doc.data();
                        if (callData.from !== currentUser.uid) {
                            showActiveCallBanner(callData, change.doc.id);
                        }
                    } else if (change.type === 'removed') {
                        hideActiveCallBanner();
                    }
                });
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const callData = doc.data();
                        if (callData.from !== currentUser.uid) {
                            showActiveCallBanner(callData, doc.id);
                            return;
                        }
                    });
                } else {
                    hideActiveCallBanner();
                }
            });
    }
}

function cleanupCallListeners() {
    if (callListener) {
        callListener();
        callListener = null;
    }
    if (activeCallListener) {
        activeCallListener();
        activeCallListener = null;
    }
    if (callAnswerListener) {
        callAnswerListener();
        callAnswerListener = null;
    }
    if (iceCandidateListener) {
        iceCandidateListener();
        iceCandidateListener = null;
    }
}

function showIncomingCall(callData, callId) {
    if (currentCall) return;

    currentCall = {
        id: callId,
        from: callData.from,
        type: callData.type,
        chatId: callData.chatId
    };

    getUserData(callData.from).then(user => {
        const notification = document.getElementById('call-notification');
        const avatar = document.getElementById('
